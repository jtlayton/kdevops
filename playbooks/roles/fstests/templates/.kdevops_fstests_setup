#!/bin/bash
# Automatically generated by kdevops

export HOST_OPTIONS=${HOST_OPTIONS:=local.config}
export FSTEST_DIR=${FSTEST_DIR:=/var/lib/xfstests}

# Modified to be run as part of root's .bashrc
known_hosts_local()
{
	[ "$HOST_CONFIG_DIR" ] || HOST_CONFIG_DIR=$FSTEST_DIR/configs

	[ -f /etc/xfsqa.config ]             && export HOST_OPTIONS=/etc/xfsqa.config
	[ -f $HOST_CONFIG_DIR/$HOST ]        && export HOST_OPTIONS=$HOST_CONFIG_DIR/$HOST
	[ -f $HOST_CONFIG_DIR/$HOST.config ] && export HOST_OPTIONS=$HOST_CONFIG_DIR/$HOST.config
}

get_config_sections() {
	sed -n -e "s/^\[\([[:alnum:]_-]*\)\]/\1/p" < $1
}

# Modified to be run as part of root's .bashrc
parse_config_section_local() {
	SECTION=$1
	if ! $OPTIONS_HAVE_SECTIONS; then
		return 0
	fi
	if [[ ! -f $HOST_OPTIONS ]]; then
		return 0
	fi
	eval `sed -e 's/[[:space:]]*\=[[:space:]]*/=/g' \
		-e 's/#.*$//' \
		-e 's/[[:space:]]*$//' \
		-e 's/^[[:space:]]*//' \
		-e "s/^\([^=]*\)=\"\?'\?\([^\"']*\)\"\?'\?$/export \1=\"\2\"/" \
		< $HOST_OPTIONS \
		| sed -n -e "/^\[$SECTION\]/,/^\s*\[/{/^[^#].*\=.*/p;}"`
}

HOST=`hostname -s`
if [ ! -f "$HOST_OPTIONS" ]; then
	known_hosts_local
fi

export OPTIONS_HAVE_SECTIONS=false
if [ -f "$HOST_OPTIONS" ]; then
	export HOST_OPTIONS_SECTIONS=`get_config_sections $HOST_OPTIONS`
	if [ -z "$HOST_OPTIONS_SECTIONS" ]; then
		. $HOST_OPTIONS
	else
		export OPTIONS_HAVE_SECTIONS=true
	fi
fi

export FSTYP='{{ fstests_fstyp }}'
export FSTESTS_SPARSE_FILE_PATH='{{ sparsefiles_path }}'
export FSTESTS_SETUP_SYSTEM='{{ fstests_setup_system }}'
export FSTESTS_TESTDEV_SPARSEFILE_GENERATION='{{ sparsefiles_generation }}'
export FSTESTS_SPARSE_FILE_SIZE='{{ sparsefiles_size }}'
export FSTESTS_SPARSE_FILENAME_PREFIX='{{ sparsefiles_filename_prefix }}'
export FSTESTS_RUN_LARGE_DISK_TESTS='{{ run_large_disk_tests }}'
export FSTESTS_RUN_AUTO_GROUP_TESTS='{{ run_auto_group_tests }}'
export FSTESTS_RUN_CUSTOM_GROUP_TESTS='{{ run_custom_group_tests }}'
{% if fstests_nfs_enable -%}
export FSTESTS_NFS_SERVER_HOST='{{ fstests_nfs_server_host }}'
export FSTESTS_ANSIBLE_HOST='{{ ansible_host }}'
{% endif %}

parse_config_section_local default
INFER_SECTION=$(echo $HOST | sed -e 's|-dev||')
INFER_SECTION=$(echo $INFER_SECTION | sed -e 's|-|_|g')
INFER_SECTION=$(echo $INFER_SECTION | awk -F"_" '{for (i=2; i <= NF; i++) { printf $i; if (i!=NF) printf "_"}; print NL}')
parse_config_section_local $INFER_SECTION
